<!DOCTYPE html>
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globgram</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="src/profile-manager.js"></script>
    <script src="src/settings-manager.js"></script>

</head>

<body>
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h2>ูุฑูุฏ ุจู ุจุฑูุงูู</h2>
            <input type="email" id="emailInput" placeholder="ุงูู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ">
            <button id="sendCodeBtn">ุฏุฑุงูุช ฺฉุฏ ุชุงุฏ</button>
            <div id="verifySection" style="display: none;">
                <input type="text" id="verifyCode" placeholder="ฺฉุฏ ุชุงุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ">
                <button id="verifyBtn">ุชุงุฏ ฺฉุฏ</button>
            </div>
        </div>
    </div>

    <div class="header-controls">
        <button id="openProfileBtn" class="profile-button">
            <span class="profile-icon">๐ค</span>
            ูพุฑููุงู ฺฉุงุฑุจุฑ
        </button>
    </div>
    <div class="container" id="mainContent" style="display: none;">
        <h1>Globgram</h1>
        <div id="userInfo"></div>
        <div class="room-controls">
            <button id="createRoom">ุงุฌุงุฏ ุงุชุงู ุฌุฏุฏ</button>
            <div id="roomCodeDisplay" style="display: none;">
                <p>ฺฉุฏ ุงุชุงู ุดูุง:</p>
                <div id="roomCode"></div>
            </div>
            <div>
                <input type="text" id="joinRoomInput" placeholder="ฺฉุฏ ุงุชุงู ุฑุง ูุงุฑุฏ ฺฉูุฏ">
                <button id="joinRoom">ูพูุณุชู ุจู ุงุชุงู</button>
    </div>
</div>
        <div id="recordings"></div>
    </div>

    <script>
        // ุชูุธูุงุช ู ุซุงุจุชโูุง
        const CONFIG = {
            EMAIL_KEY: "mIlm34r7HHZ0hsr3Z",
            EMAIL_SERVICE: "service_l5atf6s",
            EMAIL_TEMPLATE: "template_0ahwrci",
            STUN_SERVERS: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        };
        console.log('Application config loaded:', CONFIG);

        // ุฏุชุงุจุณ
        const db = new Dexie('voiceApp');
        console.log('Database instance created');

        db.version(1).stores({
            voices: '++id, voiceId, blob, timestamp, roomCode, userEmail',
            users: '++id, email, verifyCode, verified'
        });
        console.log('Database schema initialized');

        // 3. ูุชุบุฑูุง ฺฏููุจุงู
        let mediaRecorder;
        let audioChunks = [];
        let currentUser = null;
        let peer;
        let connections = [];
        let currentRoom = null;

        // 4. ุชูุงุจุน ฺฉูฺฉ
        const generateVoiceId = () => {
            return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        };

        const generateRoomCode = () => {
            return Math.floor(100000 + Math.random() * 900000).toString();
        };

        const displayRecording = (audioUrl, isRemote, timestamp, voiceId, userEmail) => {
            if (document.querySelector(`[data-voice-id="${voiceId}"]`)) {
                return;
            }

            const recordingItem = document.createElement('div');
            recordingItem.className = 'recording-item';
            recordingItem.setAttribute('data-voice-id', voiceId);

            const audio = document.createElement('audio');
            audio.src = audioUrl;
            audio.controls = true;

            const info = document.createElement('div');
            info.innerHTML = `
                <p>${isRemote ? 'ุฏุฑุงูุช ุงุฒ: ' : 'ุถุจุท ุดุฏู ุชูุณุท: '}${userEmail}</p>
                <small>${new Date(timestamp).toLocaleString('fa-IR')}</small>
            `;

            recordingItem.appendChild(audio);
            recordingItem.appendChild(info);
            document.getElementById('recordings').insertBefore(recordingItem, document.getElementById('recordings').firstChild);
        };

        // 5. ุชูุงุจุน ุงุชุตุงู ู ูุฏุฑุช ุงุชุงู
        const setupConnection = (conn) => {
            connections.push(conn);
 
            conn.on('open', async () => {
                const voices = await db.voices
                    .where('roomCode')
                    .equals(currentRoom)
                    .toArray();
          
                for (let voice of voices) {
                    const arrayBuffer = await voice.blob.arrayBuffer();
                    conn.send({
                        type: 'audio',
                        audioData: arrayBuffer,
                        timestamp: voice.timestamp,
                        voiceId: voice.voiceId,
                        userEmail: currentUser.email
                    });
                }
            });

            conn.on('data', async (data) => {
                if (data.type === 'audio') {
                    const audioBlob = new Blob([data.audioData], { type: 'audio/webm' });
                    const voiceId = generateVoiceId();
          
                    await db.voices.add({
                        voiceId,
                        blob: audioBlob,
                        timestamp: data.timestamp,
                        roomCode: currentRoom,
                        userEmail: data.userEmail
                    });

                    displayRecording(
                        URL.createObjectURL(audioBlob),
                        true,
                        data.timestamp,
                        voiceId,
                        data.userEmail
                    );
                }
            });

            peer.on('error', (error) => {
                console.log('Peer connection error:', error);
            });

            conn.on('close', () => {
                console.log('Connection closed:', conn.peer);
                connections = connections.filter(c => c !== conn);
            });
        };

        const initializePeer = (roomCode, isCreator = true) => {
            const peerId = isCreator ? roomCode : `${roomCode}-${Math.random().toString(36).substr(2, 4)}`;
  
            peer = new Peer(peerId, {
                debug: 2,
                config: { iceServers: CONFIG.STUN_SERVERS }
            });

            peer.on('open', (id) => {
                if (!isCreator) {
                    const conn = peer.connect(roomCode);
                    conn.on('open', () => {
                        setupConnection(conn);
                        alert('ุจุง ููููุช ุจู ุงุชุงู ูุชุตู ุดุฏุฏ');
                    });
                }
            });

            peer.on('connection', (conn) => {
                setupConnection(conn);
                alert('ฺฉุงุฑุจุฑ ุฌุฏุฏ ุจู ุงุชุงู ูพูุณุช');
            });
        };

        // 6. ูุงฺููโูุง ุงุตู
        const VoiceRecorder = {
            async startRecording() {
                console.log('Starting voice recording');
                if (!currentRoom) {
                    console.log('No active room found');
                    alert('ูุทูุง ุงุจุชุฏุง ูุงุฑุฏ ฺฉ ุงุชุงู ุดูุฏ');
                    return;
                }
        
                try {
                    console.log('Requesting microphone access');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('Microphone access granted');
                    mediaRecorder = new MediaRecorder(stream);
            
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const timestamp = new Date().getTime();
                        const voiceId = generateVoiceId();
                
                        await db.voices.add({
                            voiceId,
                            blob: audioBlob,
                            timestamp,
                            roomCode: currentRoom,
                            userEmail: currentUser.email
                        });

                        displayRecording(
                            URL.createObjectURL(audioBlob),
                            false,
                            timestamp,
                            voiceId,
                            currentUser.email
                        );

                        if (connections.length > 0) {
                            const arrayBuffer = await audioBlob.arrayBuffer();
                            connections.forEach(conn => {
                                if (conn.open) {
                                    conn.send({
                                        type: 'audio',
                                        audioData: arrayBuffer,
                                        timestamp,
                                        voiceId,
                                        userEmail: currentUser.email
                                    });
                                }
                            });
                        }

                        audioChunks = [];
                    };

                    mediaRecorder.onerror = (event) => {
                        console.log('MediaRecorder error:', event);
                    };

                    mediaRecorder.onstart = () => {
                        console.log('Recording started');
                    };

                    mediaRecorder.start();
                    document.getElementById('recordButton').disabled = true;
                    document.getElementById('stopButton').disabled = false;
                } catch (error) {
                    console.error('Microphone access failed:', error);
                    alert('ูุทูุง ุฏุณุชุฑุณ ูฺฉุฑูููู ุฑุง ูุนุงู ฺฉูุฏ');
                }
            },

            stopRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    document.getElementById('recordButton').disabled = false;
                    document.getElementById('stopButton').disabled = true;
                }
            }
        };
          const RoomManager = {
              init() {
                  // ุจุฑุฑุณ ูุถุนุช ุงุชุงู
                  const currentRoomCode = localStorage.getItem('currentRoomCode');
                  if (currentRoomCode) {
                      document.getElementById('welcomeScreen').style.display = 'none';
                      window.location.href = 'chat-room.html';
                      return;
                  }

                  // ุฏฺฉูู ุงุฌุงุฏ ุงุชุงู
                  document.getElementById('createRoom').onclick = () => {
                      const roomCode = generateRoomCode();
                      localStorage.setItem('currentRoomCode', roomCode);
                      document.getElementById('roomCode').textContent = roomCode;
                      document.getElementById('roomCodeDisplay').style.display = 'block';
                      window.location.href = 'chat-room.html';
                  };

                  // ุฏฺฉูู ูพูุณุชู ุจู ุงุชุงู
                  document.getElementById('joinRoom').onclick = () => {
                      const roomCode = document.getElementById('joinRoomInput').value.trim();
                      
                      if (!roomCode || roomCode.length !== 6) {
                          alert('ูุทูุง ฺฉ ฺฉุฏ 6 ุฑูู ูุนุชุจุฑ ูุงุฑุฏ ฺฉูุฏ');
                          return;
                      }
                      
                      localStorage.setItem('currentRoomCode', roomCode);
                      window.location.href = 'chat-room.html?join=true';
                  };
              }
          };

          // ูุฑุงุฎูุงู ุฏุฑ ุฒูุงู load ุตูุญู
          document.addEventListener('DOMContentLoaded', () => {
              if (window.location.pathname.includes('chat-room.html')) {
                  document.getElementById('welcomeScreen').style.display = 'none';
              }
              RoomManager.init();
          });        const Auth = {
            init() {
                emailjs.init(CONFIG.EMAIL_KEY);
                this.bindEvents();
                this.checkExistingSession();
            },

            async sendVerificationCode() {
                const email = document.getElementById('emailInput').value;
                if (!email || !email.includes('@')) {
                    alert('ูุทูุง ฺฉ ุงูู ูุนุชุจุฑ ูุงุฑุฏ ฺฉูุฏ');
                    return;
                }

                const verifyCode = Math.floor(100000 + Math.random() * 900000).toString();
        
                try {
                    await emailjs.send(CONFIG.EMAIL_SERVICE, CONFIG.EMAIL_TEMPLATE, {
                        to_email: email,
                        verification_code: verifyCode,
                        from_name: "Globgram"
                    });

                    await db.users.put({
                        email: email,
                        verifyCode: verifyCode,
                        verified: false,
                        timestamp: new Date().getTime()
                    });

                    document.getElementById('verifySection').style.display = 'block';
                    alert('ฺฉุฏ ุชุงุฏ ุจู ุงูู ุดูุง ุงุฑุณุงู ุดุฏ');
                } catch (error) {
                    console.error('ุฎุทุง ุฏุฑ ุงุฑุณุงู:', error);
                    alert('ุฎุทุง ุฏุฑ ุงุฑุณุงู ฺฉุฏ. ูุทูุง ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.');
                }
            },

            async verifyCode() {
                const email = document.getElementById('emailInput').value;
                const code = document.getElementById('verifyCode').value;
        
                try {
                    const user = await db.users
                        .where('email')
                        .equals(email)
                        .reverse()
                        .first();
            
                    if (user && user.verifyCode === code) {
                        await db.users.where('email').equals(email).modify({ verified: true });
                        localStorage.setItem('userEmail', email);
                        currentUser = user;
                        this.showMainContent();
                    } else {
                        alert('ฺฉุฏ ูุงุฑุฏ ุดุฏู ุตุญุญ ูุณุช');
                    }
                } catch (error) {
                    console.error('ุฎุทุง ุฏุฑ ุชุงุฏ:', error);
                    alert('ุฎุทุง ุฏุฑ ุชุงุฏ ฺฉุฏ');
                }
            },

            bindEvents() {
                document.getElementById('sendCodeBtn').onclick = () => this.sendVerificationCode();
                document.getElementById('verifyBtn').onclick = () => this.verifyCode();
            },

            async checkExistingSession() {
                const savedEmail = localStorage.getItem('userEmail');
                if (savedEmail) {
                    const user = await db.users.where('email').equals(savedEmail).first();
                    if (user && user.verified) {
                        currentUser = user;
                        this.showMainContent();
                    }
                }
            },

            showMainContent() {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('userInfo').textContent = `ฺฉุงุฑุจุฑ: ${currentUser.email}`;
                RoomManager.init();
            }
        };
          // 7. ุฑุงูโุงูุฏุงุฒ ุงููู
          document.addEventListener('DOMContentLoaded', () => {
              console.log('DOM fully loaded, initializing application');
    
              // ฺฉุฏ ุฌุฏุฏ ุฑุง ุงูุฌุง ุงุถุงูู ฺฉูุฏ
              document.getElementById('startButton').onclick = () => {
                  console.log('Start button clicked - Initializing application');
                  document.getElementById('welcomeScreen').style.display = 'none';
                  console.log('Welcome screen hidden');

                  if (localStorage.getItem('userEmail')) {
                      console.log('Found existing user session');
                      console.log('User email:', localStorage.getItem('userEmail'));
                      Auth.checkExistingSession();
                  } else {
                      console.log('No existing session found - showing auth container');
                      document.getElementById('authContainer').style.display = 'flex';
                  }
                  console.log('Application initialization completed');
              };

              Auth.init();
              RoomManager.init();
              console.log('Room manager initialized');
              console.log('Application initialized');
              window.addEventListener('error', (event) => {
                  console.log('Error:', event.error);
              });
        });    </script>
</body>
</html>

<!-- ุงุถุงูู ฺฉุฑุฏู ูุจู ุงุฒ div#authContainer -->
<div id="welcomeScreen" class="welcome-container">
    <div class="welcome-content">
        <h1>ุจู ุจุฑูุงูู Globgram ุฎูุด ุขูุฏุฏ</h1>
        <p>ุจุง ุงู ุจุฑูุงูู ูโุชูุงูุฏ ุจู ุฑุงุญุช ุจุง ุฏูุณุชุงู ุฎูุฏ ุงุฑุชุจุงุท ุตูุช ุจุฑูุฑุงุฑ ฺฉูุฏ</p>
        <div class="features">
            <div class="feature-item">
                <span class="icon">๐ค</span>
                <p>ุถุจุท ู ุงุฑุณุงู ูพุงู ุตูุช</p>
            </div>
            <div class="feature-item">
                <span class="icon">๐</span>
                <p>ุงุชุงูโูุง ุฎุตูุต ู ุงูู</p>
            </div>
            <div class="feature-item">
                <span class="icon">๐</span>
                <p>ุงุฑุชุจุงุท ุขููุงู ู ุณุฑุน</p>
            </div>
            <div class="feature-item">
                <span class="icon">๐ก๏ธ</span>
                <p>ุบุฑ ูุงุจู ููุชุฑ ุดุฏู</p>
            </div>
        </div>
        <button id="startButton" class="welcome-button">ุดุฑูุน ุจุฑูุงูู</button>
    </div></div>

<div id="profileSection" class="profile-container" style="display: none;">
    <div class="profile-content">
        <div class="profile-header">
            <div class="profile-icon">๐ค</div>
            <h2 id="profileName">ูุงู ฺฉุงุฑุจุฑ</h2>
            <p id="profileEmail">ุงูู ฺฉุงุฑุจุฑ</p>
        </div>
        
        <div class="settings-container">
            <!-- ุจุฎุด ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ -->
            <div class="settings-section user-section">
            </div>

            <!-- ุชูุธูุงุช ุงุตู -->
            <div class="settings-section">
                <div class="settings-item" id="accountSettings">
                    <span class="settings-icon">๐</span>
                    <span class="settings-text">ุชูุธูุงุช ุญุณุงุจ ฺฉุงุฑุจุฑ</span>
                    <span class="settings-arrow">โบ</span>
                </div>
        
                <div class="settings-item" id="chatSettings">
                    <span class="settings-icon">๐ฌ</span>
                    <span class="settings-text">ุชูุธูุงุช ฺุช ู ูพุงูโูุง</span>
                    <span class="settings-arrow">โบ</span>
                </div>

                <div class="settings-item" id="privacySettings">
                    <span class="settings-icon">๐</span>
                    <span class="settings-text">ุญุฑู ุฎุตูุต</span>
                    <span class="settings-arrow">โบ</span>
                </div>
            </div>
              <!-- ูุญุชูุง ูุนู -->
              <div class="settings-section">
                  <button id="backToMainChat" class="primary-button back-to-chat">
                      ุจุงุฒฺฏุดุช ุจู ุตูุญู ฺุช
                  </button>
              </div>
              <div class="settings-section">
                  <div class="settings-item" id="logoutButton">
                      <span class="settings-icon">๐ช</span>
                      <span class="settings-text">ุฎุฑูุฌ ุงุฒ ุญุณุงุจ ฺฉุงุฑุจุฑ</span>
                      <span class="settings-arrow">โบ</span>
                  </div>
              </div>
          </div>

<!-- ุงุถุงูู ฺฉุฑุฏู ุจุนุฏ ุงุฒ settings-container -->
<div class="settings-panels">
    <!-- ูพูู ุชูุธูุงุช ุญุณุงุจ ฺฉุงุฑุจุฑ -->
    <div id="accountSettingsPanel" class="settings-panel">
        <div class="panel-content">
            <div class="profile-avatar-section">
                <img id="profileAvatar" alt="ุชุตูุฑ ูพุฑููุงู">
                <button id="changeAvatarBtn" class="avatar-upload-btn">ุชุบุฑ ุชุตูุฑ</button>
            </div>
            <div class="setting-option">
                <label>ูุงู ฺฉุงุฑุจุฑ</label>
                <input type="text" id="userNameInput" class="settings-input" placeholder="ูุงู ฺฉุงุฑุจุฑ ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ">
                <button id="saveUserNameBtn" class="save-settings">ุฐุฎุฑู ูุงู ฺฉุงุฑุจุฑ</button>
                <button id="backToProfile" class="secondary-button">ุจุงุฒฺฏุดุช</button>
            </div>
        </div>
    </div>
</div>
    <!-- ูพูู ุชูุธูุงุช ฺุช -->    <div id="chatSettingsPanel" class="settings-panel">
        <div class="panel-header">
            <button class="back-button">โฎ</button>
            <h3>ุชูุธูุงุช ฺุช ู ูพุงูโูุง</h3>
        </div>
        <div class="panel-content">
            <div class="setting-option">
                <label>ูพุณโุฒููู ฺุช</label>
                <select id="chatBackgroundSelect">
                    <option value="light">ุฑูุดู</option>
                    <option value="dark">ุชุฑู</option>
                </select>
            </div>
            <div class="setting-option">
                <label>ฺฉูุช ุตุฏุง</label>
                <select id="audioQualitySelect">
                    <option value="high">ุจุงูุง</option>
                    <option value="medium">ูุชูุณุท</option>
                    <option value="low">ูพุงู</option>
                </select>
            </div>
        </div>
    </div>

    <!-- ูพูู ุชูุธูุงุช ุญุฑู ุฎุตูุต -->
    <div id="privacySettingsPanel" class="settings-panel">
        <div class="panel-header">
            <button class="back-button">โฎ</button>
            <h3>ุชูุธูุงุช ุญุฑู ุฎุตูุต</h3>
        </div>
        <div class="panel-content">
            <div class="setting-option">
                <label>ููุงุด ูุถุนุช ุขููุงู</label>
                <select id="onlineStatusSelect">
                    <option value="everyone">ููู</option>
                    <option value="contacts">ูุฎุงุทุจู</option>
                    <option value="nobody">ูฺฺฉุณ</option>
                </select>
            </div>
        </div>
    </div>
</div>
